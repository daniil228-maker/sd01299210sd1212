name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Клонируем код
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # 2. Устанавливаем Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    # 3. Устанавливаем системные зависимости
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          zip \
          unzip \
          openjdk-11-jdk \
          python3-pip \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          cmake \
          libffi-dev \
          libssl-dev \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev
    
    # 4. Устанавливаем Buildozer и Cython
    - name: Install Buildozer
      run: |
        pip install --upgrade pip
        pip install buildozer==1.4.0
        pip install cython==0.29.28
    
    # 5. Инициализируем Buildozer (создает buildozer.spec если нет)
    - name: Initialize Buildozer
      run: |
        if [ ! -f buildozer.spec ]; then
          echo "Creating buildozer.spec..."
          buildozer init
        else
          echo "buildozer.spec already exists"
        fi
        
        # Проверяем файлы
        echo "Current directory contents:"
        ls -la
        echo "buildozer.spec contents:"
        cat buildozer.spec
    
    # 6. Собираем APK (debug версия)
    - name: Build APK
      run: |
        # Экспортируем PATH для Buildozer
        export PATH=$PATH:$HOME/.local/bin
        
        # Очищаем предыдущие сборки
        buildozer android clean
        
        # Собираем APK
        buildozer android debug
        
        # Проверяем результат
        echo "Build complete. Checking bin directory:"
        ls -la bin/ || echo "bin directory not found"
      env:
        # Увеличиваем память для Java
        JAVA_OPTS: "-Xmx2G"
        # Устанавливаем переменную для Buildozer
        BUILDOZER_USE_CCACHE: "1"
    
    # 7. Загружаем APK как артефакт
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Notes-App-APK
        path: bin/*.apk
        retention-days: 7
